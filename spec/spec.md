# GitHub Diary Spec

GitHub Diaryは、GitHubプラットフォームを用いて日記を管理するマルチプラットフォームアプリケーションです。

## アーキテクチャ

```

USER -> This app (Desktop / Android / iOS) -(REST API)-> GitHub

```

## 機能要件

### 共通ヘッダー

- 左側に「今日」ボタンがあり、それを押すとカレンダーページの今日の日付に移動する
- 右側に設定ボタンがあり、GitHubトークンの管理や、リポジトリの指定などを行える
- 共通ヘッダーは全てのページで常時表示され、設定ボタンを押すと設定ページに遷移する

### カレンダーページ

- カレンダーで月ごとの日付を一覧できる（[Google CalendarライクなUI](calendar.png)でOK）
- カレンダーは日曜始まり
- カレンダーで月を切り替えることができる
- 月切替ボタンは常に前月/翌月へ遷移し、表示する月のカレンダーレイアウト（日曜始まり）が正しく描画されること
- スワイプ操作でも前月/翌月に切り替えることができる
- APIを利用し、その月分の日記を取得しておく
- 月を切り替えるたびに新しく取得する
- 他のページからカレンダーに戻った際にもデータをリロードする
- アプリケーション起動時は、その日の月を表示する
- 今日が何日か分かる
- どの日付に日記を書いていないか確認できる
- 今日の日記を書いていないかを確認できる（画面上部にメッセージが表示される）
  - すでに執筆している場合、カレンダーのエリアに鉛筆アイコンが表示される
- 日付を押すと、日記プレビューページへ飛ぶ
- 「Goal」ボタンがあり、それを押すと月間目標プレビューページへ飛ぶ
- GitHubのトークンやリポジトリの指定がされていない場合、ここでは「設定を行なってください」というメッセージを表示する

### 日記プレビューページ

- [GitHubのREADME.mdファイルプレビュー](diary_preview.png)と似た形でOK
- 右側に鉛筆アイコンを置き、それを押すと日記編集ページへ飛ぶ
- 左側に左矢印アイコンを押し、それを押すとカレンダーページに戻る
- スワイプ操作でもカレンダーページに戻ることができる
- GitHubの指定されたリポジトリのmainブランチから`yyyy/MM/dd/README.md`を取得する。
  - 存在しなければ、日記編集ページへ飛ぶ
- 取得されたマークダウンを、GFMに従って表示する

### 日記編集ページ

- [GitHubのエディタ画面](diary_edit.png)と似た形でOK
- エディタ画面
- GitHubの指定されたリポジトリから`yyyy/MM/dd/README.md`を取得する。
  - 存在しなければ、現在の日付のみ（`# yyyy/MM/dd (ddd)`形式）をあらかじめ入れておく
  - 存在すれば、その内容をエディタ画面に入れる
- 右側の「Save」ボタンを置き、それを押すと現在の内容を保存する
- `Cmd+S` または `Cmd+Enter` のキーボードショートカットでも保存できる
- GitHubと同程度の、マークダウンをサポートするエディタ機能をもつ
  - リスト自動継続: `- `で始まる行で改行すると、次の行にも`- `が自動挿入される
  - リスト終了: `- `のみの行で改行すると、`- `が削除されリストが終了する
- IME（日本語入力等）との互換性を保つため、TextFieldValueの状態管理はエディタコンポーネント（MarkdownEditor）内部で完結させ、外部とはString型のみでやり取りする
- 保存には、PUT `https://api.github.com/repos/{owner}/{repo}/contents/{path}` を使用する
- 保存する際には、`yyyy/MM/dd/README.md`というファイル名でmainブランチに保存する
- コンフリクトが発生した際には、その旨をエラーメッセージとして表示する
- 保存したら、カレンダーページへ戻る
- エディタ上でのプレビュー機能は不要
- テキストのみでOK
- コミットメッセージは`yyyy/MM/dd`

### 月間目標プレビューページ

- カレンダーページの「Goal」ボタンから遷移する
- GitHubの指定されたリポジトリのmainブランチから`yyyy/MM/README.md`を取得する
  - 存在しなければ、空の月間目標を表示する
- 左矢印アイコンでカレンダーページに戻る
- スワイプ操作でもカレンダーページに戻ることができる
- 鉛筆アイコンで月間目標編集ページへ飛ぶ
- 月間目標の内容を表示する（Goals、Money情報）

### 月間目標編集ページ

- 月間目標の編集を行う
- 月間目標のファイルフォーマットは以下の通り:
  ```
  # yyyy/MM

  ## Goals
  - [ ] goal_1
  - [x] goal_2

  ## Money
  - Last: 1,000
  - Front: 100
  - Back: 950
  - Total: 1,050
  - Diff: 50
  ```
- Goals: チェックリスト形式で目標を管理する
  - 目標の追加・削除・編集が可能
  - 目標の完了/未完了を切り替えられる
- Money: 収支情報を管理する
  - Last（前月残高）、Front（表の収入）、Back（裏の収入）を入力
  - Total（Front + Back）、Diff（Total - Last）は自動計算される
  - 前月のデータからLastを同期する機能がある
- 保存には、PUT `https://api.github.com/repos/{owner}/{repo}/contents/{path}` を使用する
- 保存する際には、`yyyy/MM/README.md`というファイル名でmainブランチに保存する
- コミットメッセージは`yyyy/MM`
- 保存したら、カレンダーページへ戻る

### 設定ページ

- 2つの設定がある。
- GitHubトークンの管理
  - OAuthかPAT
  - GitHubページに飛び、ログイン等の認証をすることで、必要なトークンを取得する
  - トークンはローカルに保存する。暗号化などのセキュリティやポータビリティについては考えなくて良い
  - 必要スコープ（PAT）
    - fine-grained: 対象リポジトリに対する Contents: Read/Write を付与
    - classic: `repo`（プライベートリポを扱うため）
  - PAT取得フロー
    1. 「PATで認証」ボタンを押下
    2. 外部ブラウザで `https://github.com/settings/tokens` （fine-grained推奨）を開く
    3. ユーザが生成したPATをアプリに貼り付けて保存
    4. 保存時に`GET /user`で疎通確認し、成功したら暗号化してローカル保存
    5. 失効や権限不足をAPIの401/403で検知し、再入力を促す
- リポジトリの指定
  - GitHubのリポジトリ
  - `org/repo`の形式
  - リポジトリは必ず既存のリポジトリが指定される
- GitHubと同じUIでOK
- 設定ページで「保存」ボタンを押したらカレンダーページへ戻る
- 設定フォームのリポジトリ/トークン入力はローカルに永続保存され、アプリ再起動後も復元される

### ナビゲーション

- Navigation 3ベースのスタック管理によるページ遷移
- スワイプ操作による戻るナビゲーションをサポート（カレンダーでは前月/翌月切替）
- 各ページの保存完了後はカレンダーページに戻る（バックスタックをクリアしてカレンダーを表示）

### その他

- タイムゾーンはJST
- 常にオンラインであると仮定して良い。オフラインで通信エラーが発生した場合、その旨を画面に表示する
- ローディング中はloading indicatorを表示する
- モーダルは不要

## 技術要件

以下の技術を使ってください

- プログラミング言語: Kotlin
- プロジェクト管理: Gradle
- UI: Jetpack Compose
  - Kotlin Multiplatform (Desktop / Android / iOS)
  - Desktop: JVM
- GitHub REST API
  - HTTPクライアント: Ktor Client
- DI: Koin
- テスト: JUnit 6
- ナビゲーション: Navigation 3
